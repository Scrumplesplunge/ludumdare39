class Level extends Universe {
  constructor(json, pointHandlers, readyCallback) {
    super(json.displayName);
    this.on("mousemove", event => this.adjustMouse(event));
    this.keyboard = new Keyboard(this);
    var barrier = new AsyncBarrier;
    this.horizon = loadImage(json.horizon, barrier.increment());
    this.scenery = loadImage(json.scenery, barrier.increment());
    this.target = null;
    this.cameraPosition = new Vector(0, 0);  // In world coordinates.
    this.mousePosition = new Vector(0, 0);  // In world coordinates.
    // Create all the boundaries.
    for (var i = 0, n = json.shapes.length; i < n; i++) {
      var shape = json.shapes[i];
      var a = new Vector(shape[0][0], shape[0][1]);
      for (var j = 1, m = shape.length; j < m; j++) {
        var b = new Vector(shape[j][0], shape[j][1]);
        this.add(new Boundary(a, b));
        a = b;
      }
    }
    // Create all the special items.
    for (var i in json.points) if (json.points.hasOwnProperty(i)) {
      console.log("Creating " + i + "...");
      if (!pointHandlers.hasOwnProperty(i))
        throw Error("No point handler for point type " + i);
      var position = new Vector(json.points[i][0], json.points[i][1]);
      pointHandlers[i](this, position, barrier.increment());
      delete pointHandlers[i];
    }
    barrier.wait(function() {
      console.log("Level loaded.");
      readyCallback();
    });
  }
  adjustMouse(event) {
    var center =
        new Vector(Config.screen.width * 0.5, Config.screen.height * 0.5);
    this.mousePosition =
        this.cameraPosition.sub(center).add(new Vector(event.x, event.y));
  }
  update(delta) {
    if (this.target != null) {
      var offset = this.target.position.sub(this.cameraPosition);
      var amount = 1 - Math.pow(1 - Config.cameraTrackingRate, delta);
      this.cameraPosition = this.cameraPosition.add(offset.mul(amount));
    }
    super.update(delta);
  }
  draw(context) {
    var canvas = context.canvas;
    context.save();
      var center = new Vector(canvas.width * 0.5, canvas.height * 0.5);
      var topLeft = this.cameraPosition.sub(center);
      context.drawImage(this.horizon, 0, 0);
      context.drawImage(
        this.scenery, Math.floor(topLeft.x), Math.floor(topLeft.y),
        canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
      context.translate(-topLeft.x, -topLeft.y);
      super.draw(context);
    context.restore();
  }
}

var Levels = {
  tutorial: {
    "displayName": "Tutorial Level",
    "horizon": "images/blue_horizon.png",
    "scenery": "images/tutorial_level.png",
    "shapes": [
      [
        [
          533,
          695
        ],
        [
          534,
          227.5
        ],
        [
          3399.5,
          226.5
        ],
        [
          3438.5,
          1473
        ],
        [
          3318.5,
          1481
        ],
        [
          3218,
          1430
        ],
        [
          3076,
          1383
        ],
        [
          2895,
          1345
        ],
        [
          2760.5,
          1334
        ],
        [
          2629.5,
          1347
        ],
        [
          2474.5,
          1401
        ],
        [
          2368.5,
          1447
        ],
        [
          2230.5,
          1520
        ],
        [
          2112.5,
          1524
        ],
        [
          2009.5,
          1510
        ],
        [
          1924.5,
          1519
        ],
        [
          1842,
          1511
        ],
        [
          1763,
          1519
        ],
        [
          1684,
          1511
        ],
        [
          1620,
          1509
        ],
        [
          1489.5,
          1491
        ],
        [
          1438.5,
          1479
        ],
        [
          1403.5,
          1488
        ],
        [
          1335.5,
          1488
        ],
        [
          1271.5,
          1499
        ],
        [
          1227.5,
          1493
        ],
        [
          1158.5,
          1499
        ],
        [
          1060,
          1475
        ],
        [
          1009,
          1419
        ],
        [
          985,
          1365
        ],
        [
          961,
          1269
        ],
        [
          972,
          1093
        ],
        [
          962.5,
          1068.5
        ],
        [
          990.5,
          956.5
        ],
        [
          978.5,
          925.5
        ],
        [
          986.5,
          866.5
        ],
        [
          978.5,
          846.5
        ],
        [
          980.5,
          805.5
        ],
        [
          959.5,
          739.5
        ],
        [
          999.5,
          735.5
        ],
        [
          1002.5,
          723.5
        ],
        [
          967.5,
          694.5
        ],
        [
          900.5,
          677.5
        ],
        [
          831.5,
          680.5
        ],
        [
          815.5,
          670.5
        ],
        [
          779.5,
          683.5
        ],
        [
          721.5,
          682.5
        ],
        [
          663.5,
          688.5
        ],
        [
          583.5,
          684.5
        ],
        [
          533,
          695
        ]
      ]
    ],
    "points": {
      "player": [
        600,
        670
      ],
      "monster": [
        3324,
        1452,
      ],
      "health": [
        1030,
        650
      ],
      "transformSpell": [
        1700,
        1460
      ],
      "portal": [
        3400,
        1430
      ]
    }
  },
  "level1": {
    "displayName": "Level 1",
    "horizon": "images/red_horizon.png",
    "scenery": "images/level1.png",
    "shapes": [
      [
        [
          623,
          1754.5
        ],
        [
          539,
          1730.5
        ],
        [
          513,
          1733.5
        ],
        [
          492,
          1721.5
        ],
        [
          461,
          1678.5
        ],
        [
          461,
          1644.5
        ],
        [
          493,
          1563.5
        ],
        [
          568,
          1484.5
        ],
        [
          634,
          1410.5
        ],
        [
          709,
          1426.5
        ],
        [
          803,
          1413.5
        ],
        [
          885.5,
          1379
        ],
        [
          938.5,
          1333
        ],
        [
          1038.5,
          1293
        ],
        [
          1092.5,
          1279
        ],
        [
          1154.5,
          1225
        ],
        [
          1250.5,
          1225
        ],
        [
          1413,
          1123
        ],
        [
          1427,
          1091
        ],
        [
          1419,
          1062
        ],
        [
          1409,
          1014
        ],
        [
          1363,
          977
        ],
        [
          1305,
          958
        ],
        [
          1269,
          963
        ],
        [
          1245,
          953
        ],
        [
          1158,
          945
        ],
        [
          1130,
          925
        ],
        [
          1101,
          917
        ],
        [
          1053,
          928
        ],
        [
          1006,
          923
        ],
        [
          948,
          934
        ],
        [
          913,
          921
        ],
        [
          874,
          921
        ],
        [
          827,
          909
        ],
        [
          765,
          919
        ],
        [
          726,
          935
        ],
        [
          704,
          935
        ],
        [
          684,
          914
        ],
        [
          661.5,
          903.5
        ],
        [
          608.5,
          895.5
        ],
        [
          589.5,
          883.5
        ],
        [
          563.5,
          881.5
        ],
        [
          552.5,
          886.5
        ],
        [
          545.5,
          857.5
        ],
        [
          525.5,
          831.5
        ],
        [
          543.5,
          795.5
        ],
        [
          542.5,
          764.5
        ],
        [
          523.5,
          740.5
        ],
        [
          510.5,
          709.5
        ],
        [
          528.5,
          676.5
        ],
        [
          533.5,
          649.5
        ],
        [
          518.5,
          619.5
        ],
        [
          532.5,
          587.5
        ],
        [
          530.5,
          328.5
        ],
        [
          3397.5,
          388
        ],
        [
          3413.5,
          1069
        ],
        [
          3309.5,
          1074
        ],
        [
          3281.5,
          1080
        ],
        [
          3262.5,
          1096
        ],
        [
          3248.5,
          1119
        ],
        [
          3251.5,
          1180
        ],
        [
          3171.5,
          1229
        ],
        [
          3122.5,
          1246.5
        ],
        [
          2984.5,
          1317.5
        ],
        [
          2956.5,
          1338.5
        ],
        [
          2915.5,
          1339.5
        ],
        [
          2875.5,
          1351.5
        ],
        [
          2841.5,
          1369.5
        ],
        [
          2803.5,
          1378.5
        ],
        [
          2733.5,
          1414.5
        ],
        [
          2689,
          1414.5
        ],
        [
          2656,
          1426.5
        ],
        [
          2579,
          1407.5
        ],
        [
          2548,
          1411.5
        ],
        [
          2506,
          1429.5
        ],
        [
          2458,
          1431.5
        ],
        [
          2389,
          1422.5
        ],
        [
          2353,
          1425.5
        ],
        [
          2326,
          1416.5
        ],
        [
          2260,
          1418.5
        ],
        [
          2205,
          1441.5
        ],
        [
          2153,
          1445.5
        ],
        [
          2126,
          1434.5
        ],
        [
          2029,
          1434.5
        ],
        [
          1988,
          1450.5
        ],
        [
          1945,
          1440.5
        ],
        [
          1901,
          1446.5
        ],
        [
          1851,
          1465.5
        ],
        [
          1815,
          1465.5
        ],
        [
          1794,
          1453.5
        ],
        [
          1738,
          1441.5
        ],
        [
          1675,
          1463.5
        ],
        [
          1647,
          1473.5
        ],
        [
          1613.5,
          1456
        ],
        [
          1544.5,
          1444
        ],
        [
          1475,
          1456
        ],
        [
          1428,
          1477
        ],
        [
          1406,
          1474
        ],
        [
          1383,
          1484
        ],
        [
          1329,
          1492
        ],
        [
          1247,
          1514
        ],
        [
          1177,
          1563
        ],
        [
          1110,
          1561
        ],
        [
          1053,
          1578
        ],
        [
          959.5,
          1652.5
        ],
        [
          849.5,
          1724.5
        ],
        [
          623,
          1754.5
        ]
      ],
      [
        [
          2425,
          1311
        ],
        [
          2313,
          1306
        ],
        [
          2200,
          1326
        ]
      ],
      [
        [
          2340,
          1220
        ],
        [
          2170,
          1228
        ],
        [
          2125,
          1235
        ],
        [
          1849.5,
          1217
        ],
        [
          1755.5,
          1188
        ],
        [
          1604.5,
          1128
        ],
        [
          1525.5,
          1084.5
        ],
        [
          1466.5,
          1068.5
        ],
        [
          1408.5,
          1016.5
        ]
      ],
    ],
    "points": {
      "inactivePortal": [
        3343,
        1014.5
      ],
      "monsterSpawner": [
        2314,
        1382.5
      ],
      "health": [
        2315,
        1270
      ],
      "player": [
        620,
        1700,
      ],
      "transformSpell": [
        770,
        1700
      ],
      "portalActivateSpell": [
        800,
        870
      ]
    }
  }
};
